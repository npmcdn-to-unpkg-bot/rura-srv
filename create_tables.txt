drop table texts;
drop table orphus_comments;
drop table chapters;
drop table volumes;
drop table projects;
drop table users;

create table users
(
  user_id int(11) primary key auto_increment,
  username varchar(64),
  realname varchar(255),
  pass varchar(32),
  pass_recovery_token varchar(255),
  pass_recovery_token_date datetime,
  email varchar(255),
  email_token varchar(255),
  email_token_date datetime,
  email_activated bool,
  registration_date datetime
);

create table texts
(
  text_id int(11) primary key auto_increment,
  text_wiki mediumtext,
  text_html mediumtext
);

create table orphus_comments
(
   chapter_id int(11),
   paragraph int(11),
   start_offset int(11),
   original_text varchar(255),
   replacement_text varchar(255),
   created_when datetime
);

create table projects
(
  project_id int(11) primary key auto_increment,
  parent_id int(11),
  url varchar(16),
  title varchar(1023),
  order_number int(11),
  is_banner_hidden bool,
  is_project_hidden bool,
  annotation text
);

create table volumes
(
  volume_id int(11) primary key auto_increment,
  project_id int(11),
  url varchar(16),
  name_file varchar(255),
  name_title varchar(255),
  name_jp varchar(255),
  name_en varchar(255),
  name_ru varchar(255),
  name_short varchar(64),
  order_number int(11),
  author varchar(255),
  illustrator varchar(255),
  release_date date,
  ISBN varchar(16),
  external_url varchar(255),
  annotation text
);

create table chapters
(
  chapter_id int(11) primary key auto_increment,
  volume_id int(11),
  text_id int(11),
  url varchar(16),
  title varchar(1023),
  order_number int(11),
  published bool,
  nested bool
);

create table chapter_images
(
  chapter_id int(11),
  image_id int(11),
-- to be replaced with non_colored_image_id(11), colored_image_id(11)
  order_number int(11)
);

create table external_resources
(
  resource_id int(11),
  user_id int(11),
  mime_type varchar(255),
  url varchar(255),
  title varchar(255),
  uploaded_when datetime
);

alter table chapter_images add constraint fk_image_id foreign key (image_id) references external_resources (resource_id);
alter table external_resources add constraint fk_uploaded_by foreign key (uploaded_by) references users (user_id);
alter table chapters add constraint fk_volume_id foreign key (volume_id) references volumes (volume_id);
alter table chapters add constraint fk_chapter_text_id foreign key (chapter_text_id) references chapter_texts (chapter_text_id);
alter table volumes add constraint fk_project_id foreign key (project_id) references projects (project_id);
alter table projects add constraint fk_parent_id foreign key (parent_id) references projects (project_id);
alter table orphus_comments add constraint fk_chapter_id foreign key (chapter_id) references chapters (chapter_id);
alter table orphus_comments add primary key (chapter_id, paragraph, start_offset, original_text, replacement_text);