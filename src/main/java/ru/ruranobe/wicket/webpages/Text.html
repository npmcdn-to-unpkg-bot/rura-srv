<!DOCTYPE html>
<html xmlns:wicket="http://wicket.apache.org" lang="en">
<body>
<wicket:extend>
    <div class="container">
        <div class="leftColumn">
            <div class="leftbg"></div>
            <div class="rightbg"></div>
            <div class="leftMobile"></div>
            <div class="rightMobile"></div>
            <div class="controlText">
                <div>
                    <a class="btn btn-white soderj-button"> <i class="fa fa-home"></i>
                        <div class="hint">
                            <div class="miniicon"></div>Содержание</div>
                    </a>
                    <a wicket:id="prevChapter" class="btn btn-white"> <i class="fa fa-reply"></i>
                        <div class="hint">
                            <div class="miniicon"></div>Предыдущая глава</div>
                    </a>
                    <a wicket:id="nextChapter" class="btn btn-white"> <i class="fa fa-share"></i>
                        <div class="hint">
                            <div class="miniicon"></div>Следующая глава</div>
                    </a>
                    <div class="btn btn-white bookmark-button" data-active="false"> <i class="fa fa-bookmark"></i>
                        <div class="hint">
                            <div class="miniicon"></div>Создать закладку</div>
                    </div>
                    <div class="btn btn-white top-button"> <i class="fa fa-arrow-up"></i>
                        <div class="hint">
                            <div class="miniicon"></div>Вверх</div>
                    </div>
                    <div class="btn btn-white daynight-button"> <i class="fa fa-sun-o"></i>
                        <div class="hint">
                            <div class="miniicon"></div>Смена режима</div>
                    </div>
                    <div class="btn btn-white mistake-button"> <i class="fa fa-comment"></i>
                        <div class="hint">
                            <div class="miniicon"></div>Нашли ошибку? Тык!</div>
                    </div>
                    <div class="btn btn-white options-button"> <i class="fa fa-cog"></i>
                        <div class="hint">
                            <div class="miniicon"></div>
                            <p>Шрифт</p>
                            <div class="font active" data-name="helvetica">
                                <div class="type helvetica">A</div>
                                <div class="fontname helvetica">Helvetica</div>
                            </div>
                            <div class="font" data-name="georgia">
                                <div class="type georgia">A</div>
                                <div class="fontname georgia">Georgia</div>
                            </div>
                            <p>Размер</p>
                            <div class="fontslider" align="center">
                                <input id="fontslide" type="range" min="0" max="2" step="1" />
                            </div>
                            <p>Цвета</p>
                            <div class="pagecolors" align="center">
                                <div class="day">
                                    <div class="pagecolor white" data-color="white"></div>
                                    <div class="pagecolor red" data-color="red"></div>
                                    <div class="pagecolor blue" data-color="blue"></div>
                                    <div class="pagecolor black" data-color="black"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <main class="content">
                <div class="text">
                    <span wicket:id="htmlText"/>
                </div>
            </main>
        </div>


        <div class="comments">
            <div class="comment">
                <div class="avatar">
                    <div class=""><img src="#" width="80" height="80">
                    </div>
                </div>
                <div style="margin-left: 90px;">
                    <div class="name pull-left bold">Анонимный участник №1</div>
                    <div class="timeAgo">2 дня назад</div>
                    <div class="commentText">
                        <div>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Earum nam reiciendis molestias itaque, excepturi aut error quam necessitatibus! Voluptate et veniam sed? Cupiditate omnis, aut unde aliquid blanditiis, nam in.</div>
                        <div>Minus voluptates repellat sapiente quam! Officia explicabo expedita aut blanditiis quibusdam, natus voluptatem libero eaque magnam molestiae unde neque, repellendus! Fugit ipsum voluptates quas vero vel dolore quisquam mollitia consequatur?</div>
                    </div>
                    <a href="#" class="commentAnswer bold">Ответить</a>
                    <div class="comment">
                        <div class="avatar">
                            <div class=""><img src="#" width="80" height="80">
                            </div>
                        </div>
                        <div style="margin-left: 90px;">
                            <div class="name pull-left bold">Анонимный участник №1</div>
                            <div class="timeAgo">2 дня назад</div>
                            <div class="commentText">
                                <div>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Earum nam reiciendis molestias itaque, excepturi aut error quam necessitatibus! Voluptate et veniam sed? Cupiditate omnis, aut unde aliquid blanditiis, nam in.</div>
                                <div>Minus voluptates repellat sapiente quam! Officia explicabo expedita aut blanditiis quibusdam, natus voluptatem libero eaque magnam molestiae unde neque, repellendus! Fugit ipsum voluptates quas vero vel dolore quisquam mollitia consequatur?</div>
                            </div>
                            <a href="#" class="commentAnswer bold">Ответить</a>
                        </div>
                    </div>
                    <!-- Конец ответа на комментарий -->
                </div>
            </div>
            <!-- Конец комментария -->
            <div class="comment">
                <div class="avatar">
                    <div class=""><img src="#" width="80" height="80">
                    </div>
                </div>
                <div style="margin-left: 90px;">
                    <div class="name pull-left bold">Анонимный участник №1</div>
                    <div class="timeAgo">2 дня назад</div>
                    <div class="commentText">
                        <div>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Earum nam reiciendis molestias itaque, excepturi aut error quam necessitatibus! Voluptate et veniam sed? Cupiditate omnis, aut unde aliquid blanditiis, nam in.</div>
                        <div>Minus voluptates repellat sapiente quam! Officia explicabo expedita aut blanditiis quibusdam, natus voluptatem libero eaque magnam molestiae unde neque, repellendus! Fugit ipsum voluptates quas vero vel dolore quisquam mollitia consequatur?</div>
                    </div>
                    <a href="#" class="commentAnswer bold">Ответить</a>
                    <div class="comment">
                        <div class="avatar">
                            <div class=""><img src="#" width="80" height="80">
                            </div>
                        </div>
                        <div style="margin-left: 90px;">
                            <div class="name pull-left bold">Анонимный участник №1</div>
                            <div class="timeAgo">2 дня назад</div>
                            <div class="commentText">
                                <div>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Earum nam reiciendis molestias itaque, excepturi aut error quam necessitatibus! Voluptate et veniam sed? Cupiditate omnis, aut unde aliquid blanditiis, nam in.</div>
                                <div>Minus voluptates repellat sapiente quam! Officia explicabo expedita aut blanditiis quibusdam, natus voluptatem libero eaque magnam molestiae unde neque, repellendus! Fugit ipsum voluptates quas vero vel dolore quisquam mollitia consequatur?</div>
                            </div>
                            <a href="#" class="commentAnswer bold">Ответить</a>
                        </div>
                    </div>
                    <!-- Конец ответа на комментарий -->
                </div>
            </div>
            <!-- Конец комментария -->
        </div>
    </div>



    <div class="module scrollspy" id="contents-module">
        <div data-spy="affix">
            <div class="module_name opened">
                <i class="fa fa-chevron-down pull-left"></i>
                <div class="h4">Содержание</div>
            </div>
            <div class="actions">

                <ul id="nav" class="nav ContentNav">

                    <wicket:container wicket:id="h2Repeater">
                        <li>
                            <a wicket:id="h2level"/>
                            <ul class="nav ContentNav">
                                <wicket:container wicket:id="h3Repeater">
                                    <li>
                                        <a wicket:id="h3level"/>
                                        <ul class="nav ContentNav">
                                            <wicket:container wicket:id="h4Repeater">
                                                <a wicket:id="h4level"/>
                                            </wicket:container>
                                        </ul>
                                    </li>
                                </wicket:container>
                            </ul>
                        </li>
                    </wicket:container>

                    <li>
                        <a href="#footnotes">Примечания</a>
                    </li>

                    <li>
                        <a href="#comments">Комментарии</a>
                    </li>
                    <!--li><a href="#p1">Пролог 1</a>
                        <ul class="nav ContentNav">
                            <li><a href="#p1ch1">Глава 1</a>
                            </li>
                            <li><a href="#p1ch2">Глава 2</a>
                            </li>
                            <li><a href="#p1ch3">Глава 3</a>
                            </li>
                            <li><a href="#p1ch4">Глава 4</a>
                            </li>
                        </ul>
                    </li>
                    <li><a href="#p2">Пролог 2</a>
                        <ul class="nav ContentNav">
                            <li><a href="#p2ch1">Глава 1</a>
                            </li>
                            <li><a href="#p2ch2">Глава 2</a>
                            </li>
                            <li><a href="#p2ch3">Глава 3</a>
                            </li>
                        </ul>
                    </li>
                    <li><a href="#i1">Интерлюдия 1</a>
                    </li>
                    <li><a href="#c1">Часть первая — Underworld</a>
                        <ul class="nav ContentNav">
                            <li><a href="#c1ch1">Глава 1</a>
                            </li>
                            <li><a href="#c1ch2">Глава 2</a>
                            </li>
                            <li><a href="#c1ch3">Глава 3</a>
                            </li>
                            <li><a href="#c1ch4">Глава 4</a>
                            </li>
                            <li><a href="#c1ch5">Глава 5</a>
                            </li>
                            <li><a href="#c1ch6">Глава 6</a>
                            </li>
                        </ul>
                    </li>
                    <li><a href="#a">Послесловие автора</a>
                    </li>
                    <li><a href="#references">Примечания</a>
                    </li>
                    <li><a href="#comments">Комментарии</a>
                    </li-->
                </ul>
            </div>
        </div>
    </div>


    <script type="text/javascript">
        $(document).ready(function() {
            $(".fancybox")
                    .attr('rel', 'gallery')
                    .fancybox({
                        mouseWheel: false,
                        padding: 0,
                        margin: 5,
                        scrolling: 'no',
                        autoResize: false,
                        fitToView: true,
                        afterLoad: function () {
                            var fancy=this;
                            this.outer.mousewheel(function (e,a1) {
                                fancy.wrap.css('width','auto');
                                var d=Math.pow(1.1,a1);
                                var x=e.pageX-fancy.inner.offset().left;
                                var y=e.pageY-fancy.inner.offset().top;
                                fancy.inner.width(fancy.inner.width()*d);
                                fancy.inner.height(fancy.inner.height()*d);
                                fancy.wrap.css('left',fancy.wrap.position().left+x*(1-d));
                                fancy.wrap.css('top',fancy.wrap.position().top+y*(1-d));
                                return false;
                            });
                            this.wrap.draggable();
                        }
                    });
        });

        /* AFFIX */
        function reinitAffix() {
            $(window).off('.affix')
            $('#contents-module>div').removeData('bs.affix').removeClass('affix affix-top affix-bottom')
                    .css('top', '').affix({
                        offset: {
                            top: $('#contents-module > div').offset().top - 20,
                            bottom: $('footer').outerHeight(true)
                        }
                    })
            $('.controlText>div').removeData('bs.affix').removeClass('affix affix-top affix-bottom')
                    .css('top', '').affix({
                        offset: {
                            top: $('.controlText > div').offset().top - 40,
                            bottom: $(document).height() - ($('#comments').length ? $('#comments').offset().top : $('.leftColumn').offset().top + $('.leftColumn').outerHeight(true))
                        }
                    });
        }
        $(window).resize(reinitAffix);
        $(document).ready(function() {
            reinitAffix();
        });
        /* AFFIX */

        /* ИНСТРУМЕНТЫ */
        $('.daynight-button').on('click', function(e) {
            if ($(this).children('.fa').hasClass('fa-sun-o')){
                $('body').addClass("night");
                $('a.navbar-brand img').attr('src','img/logo1_night.png');
                saveSettings({
                    key: 'night',
                    item: true
                });
            } else {
                $('body').removeClass("night");
                $('a.navbar-brand img').attr('src','img/logo1.png');
                saveSettings({
                    key: 'night',
                    item: false
                });
            }
            $(this).children('.fa').toggleClass('fa-sun-o fa-moon-o');
        });
        $('.controlText .btn').hover(
                function() {
                    $(this).children('.hint').show()
                    if ($(this).hasClass('options')) $(this).addClass('activated');
                },
                function() {
                    $(this).children('.hint').hide()
                    if ($(this).hasClass('options')) $(this).removeClass('activated');
                }
        );
        $('.btn.top-button').click(function() {
            $(document).scrollTop(0);
        });
        $('.overlayT').click(function() {
            $('.overlayT').hide();
            $('div.mistake').hide();
        });
        $('.btn').hover(
                function() {
                    $(this).children('.hint').show()
                },
                function() {
                    $(this).children('.hint').hide()
                }
        );
        $('.controlText .btn.disable').attr('disabled', 'disabled');
        /* ИНСТРУМЕНТЫ */

        /* MOBILE */
        function isMobile() {
            try {
                document.createEvent("TouchEvent");
                return true;
            } catch (e) {
                return false;
            }
        }

        var $right = $('#contents-module');
        var $center = $('.leftColumn');
        var $left = $('.controlText > div');

        function OpenRight() {
            if ($left.hasClass("active")) {
                $left.removeClass("active");
                $center.removeClass("activeLeft");
            } else {
                $right.addClass("active");
                $right.children('div').addClass("active");
                $center.addClass("activeRight");
            }
        }

        function OpenLeft() {
            if ($right.hasClass("active")) {
                $right.removeClass("active");
                $right.children('div').removeClass("active");
                $center.removeClass("activeRight");
            } else {
                $left.addClass("active");
                $center.addClass("activeLeft");
            }
        }
        $('.leftbg').click(OpenRight);
        $('.rightbg').click(OpenLeft);
        $('.leftMobile').click(OpenLeft);
        $('.rightMobile').click(OpenRight);
        $('.soderj-button').click(function() {
            OpenRight();
            OpenRight();
        });
        if (isMobile() == true) $(".leftColumn").swipe({
            swipeLeft: function() {
                OpenRight()
            },
            swipeRight: function() {
                OpenLeft()
            },
            threshold: 100,
            excludedElements: $.fn.swipe.defaults.excludedElements
        });
        $('#nav').click(function() {
            $right.removeClass("active");
            $right.children('div').removeClass("active");
            $center.removeClass("activeRight");
        });
        $('.controlText .btn').click(function() {
            if ($(this).hasClass('options-button')) {
                return false;
            }
            $left.removeClass("active");
            $center.removeClass("activeLeft");
        });
        $('.controlText .btn.options-button').click(function() {
            if ($(this).hasClass('activated')) {
                return false;
            }
            $('.controlText .btn.options-button').addClass('activated');
            if (isMobile() == true) $('.overlayT').show();
        })
        $('.overlayT').click(function() {
            $('.overlayT').hide();
            $('.controlText .btn.options-button').removeClass('activated');
            $left.removeClass("active");
            $center.removeClass("activeLeft");
        });
        /* MOBILE */

        /*
         $(function(){
         var lastScrollTop = 0, delta = 5;
         $(window).scroll(function(event){
         var st = $(this).scrollTop();
         if(Math.abs(lastScrollTop - st) <= delta)
         return;

         if (st < lastScrollTop){
         // upscroll code
         $('.navbar-static-top').addClass('active')
         $('.navbar-lower').addClass('active')
         } else {
         // downscroll code
         $('.navbar-static-top').removeClass('active')
         $('.navbar-lower').removeClass('active')
         }
         lastScrollTop = st;
         });
         })
         */

        /* НАСТРОЙКИ */
        $('.options-button .font').click(function() {
            if ($(this).hasClass("active")) {} else {
                $('.options-button .font').removeClass("active");
                $(this).addClass("active");
                $('.text').css('font-family', $(this).data('name'));
            }
            saveSettings({
                key: 'fontname',
                item: $(this).data('name')
            });
        })
        $('.options-button .pagecolor').click(function() {
            if ($(this).hasClass("active")) {} else {
                $('.options-button .pagecolor').removeClass("active");
                $(this).addClass("active");
                $('body').removeClass($('body').data('color'));
                $('body').addClass($(this).data('color'));
                $('body').data('color', $(this).data('color'));
                saveSettings({
                    key: 'bgcolor',
                    item: $(this).data('color')
                });
            }
        })
        $("#fontslide").on("change mousemove", function() {
            var font = '';
            switch ($(this).val()) {
                case '0':
                    font = '80%';
                    break;
                case '1':
                    font = '100%';
                    break;
                case '2':
                    font = '120%';
                    break;
            }
            $('.text').css('font-size', font);
            saveSettings({
                key: 'fontsize',
                item: $(this).val()
            });
        });

        function supportsLocalStorage() {
            try {
                return 'localStorage' in window && window['localStorage'] !== null;
            } catch (e) {
                return false;
            }
        }

        function saveSettings(options) {
            if (!supportsLocalStorage()) {
                return false;
            }
            localStorage.setItem(options.key, options.item);
        }

        function loadSettings() {
            if (!supportsLocalStorage()) {
                return false;
            }
            if (localStorage.getItem("bgcolor") != undefined) {
                $('body').addClass(localStorage.getItem("bgcolor"));
                $('body').attr('data-color', localStorage.getItem("bgcolor"));
                $('.options-button .pagecolor[data-color="' + localStorage.getItem("bgcolor") + '"]').addClass('active');
            }
            if (localStorage.getItem("night") == "true") {
                $('body').addClass("night");
                $('a.navbar-brand img').attr('src','img/logo1_night.png');
                $('.daynight-button .fa').toggleClass('fa-sun-o fa-moon-o');
            } else {
                $('body').removeClass("night");
                $('a.navbar-brand img').attr('src','img/logo1.png');
            }
            if (localStorage.getItem("fontsize")) {
                var font = '';
                switch (localStorage.getItem("fontsize")) {
                    case '0':
                        font = '80%';
                        break;
                    case '1':
                        font = '100%';
                        break;
                    case '2':
                        font = '120%';
                        break;
                }
                $('.text').css('font-size', font);
                $("#fontslide").val(localStorage.getItem("fontsize"));
            }
            if (localStorage.getItem("fontname")) {
                $('.options-button .font.' + localStorage.getItem("fontname")).addClass("active");
                $('.text').css('font-family', localStorage.getItem("fontname"));
            }
        }
        $(document).ready(function() {
            loadSettings()
        });
        /* НАСТРОЙКИ */

        /* ЗАКЛАДКИ */
        function hideP() {
            $('.text p').removeClass('show');
            $('.text p').off('click');
            $('.btn.bookmark-button').attr('data-active', false);
        }
        $('.controlText .btn.bookmark-button').click(function() {
            $('.text p')
                    .addClass('show')
                    .on('click', function() {
                        alert($(this).attr('id'));
                        saveSettings({
                            key: 'bookmark',
                            item: $(this).attr('id')
                        });
                        hideP()
                    });
            setTimeout(function() {
                $('.btn.bookmark-button').attr('data-active', true)
            }, 2000);
        });
        $('body').click(function(eventObject) {
            if ($(eventObject.target).closest('div.text').length == 0 && $(eventObject.target).closest(".btn.bookmark-button").length == 0) {
                hideP()
            }
        });
        $('.controlText .btn.bookmark-button').click(function() {
            if ($(this).attr('data-active') == "true") {
                hideP()
            }
        });
        $('body').keydown(function(eventObject) {
            if (eventObject.which == 27) {
                hideP()
            }
        });
        /* ЗАКЛАДКИ */


        /* MODAL */
        function getText() {
            if (window.getSelection) {
                return window.getSelection() + "";
            } else if (document.getSelection) {
                return document.getSelection() + "";
            } else if (document.selection) {
                return document.selection.createRange().text + "";
            }
            return '';
        }
        $('div.mistake').on('hidden.bs.modal', function(e) {
            $('body').css('padding', 0)
        })
        $('.btn.mistake-button').click(function() {
            var Mistake = getText();
            if (Mistake == "" || Mistake == ' ') {
                alert('Для начала, выделите ошибку!');
            } else {
                var Parameters = getOrphusParameters();
                var chapterId = $('.chapter').data('chapter');
                console.log(Parameters);
                console.log(chapterId);
                var callbackUrl = '';
                showOrphusDialog(Parameters.originalText, callbackUrl, Parameters.startOffset, Parameters.paragraph, chapterId);
            }
        });
        /* MODAL */
        /* ОШИБКИ */
        function showOrphusDialog(originalText, callbackUrl, startOffset, paragraph, chapterId) {
            bootbox.dialog({
                title: "Предложить правку",
                message: '<form id="orphusForm">' +
                '  <div class="form-group">' +
                '    <label for="orphusReplacement">Текст правки</label>' +
                '    <input type="text" class="form-control" name="replacementText" id="orphusReplacement" value="' + originalText + '">' +
                '    <p class="help-block" style="display: none"></p>' +
                '  </div>' +
                '  <div class="form-group">' +
                '    <label for="orphusComment">Комментарий <small>(необязательно)</small></label>' +
                '    <input type="text" class="form-control" name="optionalComment" id="orphusComment">' +
                '  </div>' +
                '</form>',
                buttons: {
                    cancel: {
                        label: "Отменить",
                        className: "btn-default",
                        callback: function() {}
                    },
                    success: {
                        label: "Подтвердить",
                        className: "btn-success",
                        callback: function() {
                            /* TODO: text size check */
                            var replacement = $('#orphusReplacement').val();
                            if (!replacement) {
                                $('#orphusReplacement').next('.help-block').text('Введите текст для замены.').show();
                                $('#orphusReplacement').parent('.form-group').addClass('has-error');
                                return false;
                            }
                            if (replacement == originalText) {
                                $('#orphusReplacement').next('.help-block').text('Текст для замены должен отличаться от исходного.').show();
                                $('#orphusReplacement').parent('.form-group').addClass('has-error');
                                return false;
                            }
                            var data = $('#orphusForm').serialize();
                            var wcall = Wicket.Ajax.get({
                                'u': callbackUrl + '&' + data + '&startOffset=' + startOffset + '&paragraph=' + paragraph + '&chapterId=' + chapterId + '&originalText=' + originalText
                            });
                        }
                    }
                }
            });
        }


        /* variable attrs come from wicket framework */
        function isOrphusPreconditionsMet(attrs) {
            if ($('#orphusForm').length) {
                return false;
            }
            var keycode = Wicket.Event.keyCode(attrs.event);
            if ((keycode == 13) && (attrs.event.ctrlKey)) //ctrl+enter
            {
                var range = getSelectionRange();
                if (range && range.toString().length > 0) {
                    /* TODO: tag p must have associated 'id' attribute.
                     *  Probably with special format like ch+chapterId+p+paragraph
                     *  where paragraph is just порядковый номер абзаца :) */
                    return $(range.startContainer).closest('p').is($(range.endContainer).closest('p'));
                }
            }
            return false;
        }

        function getSelectionRange() {
            if (window.getSelection && window.getSelection().rangeCount > 0) {
                return window.getSelection().getRangeAt(0);
            } else if (document.selection && document.selection.type != "Control") {
                return document.selection.createRange();
            }
            return null;
        }

        function getOrphusParameters() {
            var range = getSelectionRange();
            var p = $(range.startContainer).closest('p').get(0);
            var offset = 0;
            if (range.cloneRange) {
                var preCaretRange = range.cloneRange();
                preCaretRange.selectNodeContents(p);
                preCaretRange.setEnd(range.endContainer, range.endOffset);
                offset = preCaretRange.toString().length;
            } else {
                var preCaretTextRange = document.body.createTextRange();
                preCaretTextRange.moveToElementText(p);
                preCaretTextRange.setEndPoint("EndToEnd", range);
                offset = preCaretTextRange.text.length;
            }
            /* TODO: add chapterId parameter. Maybe in wicket code */
            return {
                originalText: range.toString(),
                startOffset: offset - range.toString().length,
                paragraph: p.id
            };
        }
        /* ОШИБКИ */



        /* ПРИМЕЧАНИЯ */
        $(".reference").popover({
            trigger: 'hover',
            title: 'Примечание',
            placement: 'bottom'
        });
    </script>
</wicket:extend>
<div class="overlayT"></div>
</body>
</html>
